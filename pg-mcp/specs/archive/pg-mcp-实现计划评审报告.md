# PostgreSQL MCP Server - 实现计划评审报告

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 评审日期 | 2025-12-20 |
| 被评审文档 | 0004-pg-mcp-impl-plan.md |
| 评审工具 | OpenAI Codex CLI v0.73.0 |
| 评审模型 | gpt-5.1-codex-max |

---

## 执行摘要

本实现计划结构清晰，包含明确的阶段划分、可交付成果和验收标准，并强调了 SQL 安全性和测试完整性。但在一些关键的运维、安全和测试细节方面存在不足。依赖关系映射存在偏差，验证器范围和可观测性计划需要在实施前进一步细化。

**总体评判：需要修订**

---

## 优势亮点

1. **明确的分阶段交付**，每个任务都有具体的产出物和验收标准
2. **强调 SQL 安全性**（验证器优先）、配置建模和 Schema 缓存机制
3. **明确的测试意图**，每个阶段都包含单元测试、集成测试和端到端测试示例
4. **包含韧性和可观测性阶段**，以及 MVP 里程碑，便于利益相关者对齐

---

## 需要改进的问题

### 问题 1：阶段依赖顺序错误

| 属性 | 内容 |
|------|------|
| **位置** | 4. 依赖关系图 / 阶段排序 |
| **严重性** | 中等 |
| **类别** | 技术准确性 |
| **描述** | 阶段 5（查询执行器）依赖阶段 3（数据库），但显示在阶段 4（LLM）之后。这迫使 LLM 必须完成后才能构建/测试执行器，阻塞了早期的数据库执行验证。 |
| **建议** | 在依赖图中解耦执行器和 LLM：阶段 3 → 阶段 5 与阶段 4 并行/独立；阶段 6 应同时依赖两者。 |

### 问题 2：SQL 验证器范围不完整

| 属性 | 内容 |
|------|------|
| **位置** | 阶段 2 – SQL 安全验证器（任务/规则） |
| **严重性** | 高 |
| **类别** | 完整性 |
| **描述** | 验证器规则遗漏了常见的可能产生副作用的非 SELECT 语句（如 `SET`、`SHOW`、`RESET`、`COPY`、`CALL`、`DO`、`LISTEN/NOTIFY`、`VACUUM/ANALYZE`、`ALTER SYSTEM`、临时表创建、函数创建、`SECURITY DEFINER` 等）。缺乏明确处理会留下权限提升或资源影响的漏洞。 |
| **建议** | 扩展规则矩阵和测试，明确拒绝所有非只读语句和会话变更命令；为这些情况添加解析和测试。 |

### 问题 3：Schema 缓存故障处理

| 属性 | 内容 |
|------|------|
| **位置** | 阶段 3 – Schema 缓存 & 阶段 8 韧性 |
| **严重性** | 中等 |
| **类别** | 风险 |
| **描述** | 计划涵盖自动刷新，但未涵盖失败模式（部分/内省错误、缓存预热超时、陈旧缓存使用）或运行时手动刷新/失效。 |
| **建议** | 添加降级策略（提供陈旧数据 vs 失败）、手动刷新钩子/工具，以及缓存年龄/加载失败的指标/告警；包含刷新失败和陈旧读取的测试。 |

### 问题 4：LLM 安全和成本控制

| 属性 | 内容 |
|------|------|
| **位置** | 阶段 4 – LLM 集成 & 阶段 7 服务器 |
| **严重性** | 高 |
| **类别** | 清晰度 / 风险 |
| **描述** | 缺少提示/响应日志记录的防护措施和 PII/密钥脱敏；缺少成本/延迟控制（速率限制、每个请求的 token 上限）以及与可观测性的对齐。 |
| **建议** | 在日志/指标中指定密钥/凭证的脱敏，在生成器中强制执行 token/延迟预算，并包含日志清理和模拟 LLM 错误路径的测试。 |

### 问题 5：集成/端到端测试环境

| 属性 | 内容 |
|------|------|
| **位置** | 测试策略（阶段 3、5、7、10） |
| **严重性** | 高 |
| **类别** | 完整性 |
| **描述** | 集成/端到端测试引用"真实数据库"，但没有确定性设置。没有固定的 Schema/数据、Docker 化的 Postgres 配置或 CI 测试方案。存在测试不稳定和自动化阻塞的风险。 |
| **建议** | 定义 docker-compose Postgres 固件，包含种子 Schema/数据；为 CI 添加测试种子/迁移；记录如何在本地和 CI 中运行集成/端到端测试。 |

### 问题 6：可观测性规范

| 属性 | 内容 |
|------|------|
| **位置** | 阶段 9 可观测性 |
| **严重性** | 中等 |
| **类别** | 完整性 |
| **描述** | 列出了指标/日志/追踪，但未连接到 FastMCP 服务器端点，也未涵盖查询/结果脱敏或采样。没有健康检查/就绪性语义的计划。 |
| **建议** | 指定 Prometheus 端点路径/端口、日志字段/脱敏规则、追踪传播以及就绪性/活性定义；添加指标暴露和健康端点的测试/检查。 |

---

## 缺失考虑

当前计划未涵盖以下重要方面：

| 类别 | 缺失内容 |
|------|----------|
| **运维手册** | 配置重载策略、数据库/LLM 凭证轮换、重复 OpenAI 失败的退避策略 |
| **性能测试** | 并发请求和大结果集的性能/负载测试 |
| **大输出安全** | 大输出的安全措施（行/字节上限）和超出行限制的分页策略 |
| **多租户隔离** | 多租户/数据库隔离细节（每数据库连接池限制、角色映射） |
| **部署管道** | 除 Docker 提及外的部署打包/CI 步骤（构建、发布、版本控制） |

---

## 技术评审

### 阶段依赖关系正确性

**状态：需要调整**

- 执行器应跟随数据库（阶段 3），而非 LLM（阶段 4）
- 编排器（阶段 6）依赖于执行器和 LLM 生成器
- 当前图强制在执行器测试之前完成 LLM

**推荐依赖关系图：**

```
阶段 0
    │
    ▼
阶段 1
    │
    ├─────────────────┐
    ▼                 ▼
阶段 2           阶段 3
    │                 │
    │         ┌───────┴───────┐
    │         ▼               ▼
    │     阶段 4         阶段 5
    │         │               │
    │         └───────┬───────┘
    │                 ▼
    └─────────▶ 阶段 6
                      │
                      ▼
                阶段 7
                      │
           ┌──────────┴──────────┐
           ▼                     ▼
       阶段 8               阶段 9
           │                     │
           └──────────┬──────────┘
                      ▼
                阶段 10
```

### 任务分解完整性

**状态：覆盖良好，但有缺口**

- 验证器规则需要扩展以覆盖会话变更命令
- 未定义缓存故障处理任务
- 缺少运维/CI 管道任务
- 未指定测试数据种子任务

### 风险评估充分性

**状态：不完整**

缺失风险：
- 会话变更语句注入
- 日志/PII 数据泄露
- 确定性测试环境可用性
- 内省失败期间的缓存陈旧性
- Token 预算耗尽
- 并发查询资源耗尽

### 测试策略完整性

**状态：部分完整**

| 方面 | 状态 | 备注 |
|------|------|------|
| 单元测试覆盖 | 详细 | SQL 验证器的示例用例良好 |
| 集成环境 | 未充分指定 | 没有 docker-compose，没有种子数据 |
| 端到端测试设置 | 缺失 | 未定义 MCP 协议测试框架 |
| 日志/可观测性测试 | 缺失 | 没有日志清理测试 |
| CI 管道集成 | 未定义 | 未指定 CI 工作流 |

---

## 建议

### 优先级 1（实施前必须修复）

1. **修复依赖图/顺序**，以解除早期数据库执行器/测试的阻塞
2. **扩展 SQL 验证器范围**和测试，以涵盖所有非只读/会话变更命令
3. **定义确定性集成/端到端环境**（Docker 化 Postgres + 种子数据）和 CI 运行手册

### 优先级 2（应该修复）

4. **添加日志/指标脱敏**、token/延迟预算和健康/指标端点规范
5. **记录缓存故障/陈旧策略**，并添加刷新失败测试/指标
6. **添加多租户隔离规范**，用于每数据库连接池

### 优先级 3（最好有）

7. 定义运维手册（凭证轮换、配置重载）
8. 添加性能/负载测试阶段
9. 指定部署管道（构建、发布、版本控制）

---

## 行动项

基于此评审，应对实施计划进行以下更改：

- [ ] 更新依赖图，允许阶段 5 与阶段 4 并行
- [ ] 为阶段 2 添加额外 SQL 命令验证任务（SET、CALL、DO 等）
- [ ] 为阶段 2 添加会话变更命令的测试用例
- [ ] 为阶段 3 添加缓存故障处理任务（降级策略）
- [ ] 为阶段 3/8 添加手动缓存刷新钩子任务
- [ ] 为阶段 4 添加日志脱敏和 token 预算控制任务
- [ ] 为阶段 9 添加健康/就绪端点定义任务
- [ ] 在阶段 0 中创建 `docker-compose.test.yml` 规范
- [ ] 在阶段 10 中添加测试数据种子策略
- [ ] 在阶段 10 中添加 CI 管道工作流定义
- [ ] 将运维手册项目记录为阶段 10 可交付成果

---

## 结论

实施计划提供了坚实的基础，包含清晰的阶段划分和可交付成果。但在实施开始前，需要在几个关键领域进行修订：

1. **依赖顺序**需要调整以支持并行开发
2. **安全覆盖**必须扩展 SQL 验证
3. **测试基础设施**需要确定性环境规范
4. **可观测性**需要更具体的端点和脱敏规范

在解决这些修订后，计划将准备好进行实施。

---

## 修订历史

| 版本 | 日期 | 作者 | 修改内容 |
|------|------|------|----------|
| v1.0 | 2025-12-20 | OpenAI Codex CLI | 初始评审 |
